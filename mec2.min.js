/**
 * mec (c) 2018 Stefan Goessner
 * @license MIT License
 */
"use strict";const mec={EPS:1.19209e-7,lenTol:.1,angTol:1/180*Math.PI,velTol:.01,forceTol:.1,momentTol:.01,maxLinCorrect:20,asmItrMax:128,itrMax:256,corrMax:64,labels:{nodes:false,constraints:true,loads:true},linkage:{nodes:true,constraints:true},showNodeLabels:false,showConstraintLabels:true,showLoadLabels:true,darkmode:false,get validConstraintColor(){return this.darkmode?"#ffffff99":"#777"},invalidConstraintColor:"#b11",get forceColor(){return this.darkmode?"crimson":"orange"},get springColor(){return this.darkmode?"lightslategray":"#aaa"},get constraintVectorColor(){return this.darkmode?"orange":"green"},get hoveredElmColor(){return this.darkmode?"white":"gray"},get selectedElmColor(){return this.darkmode?"yellow":"blue"},get txtColor(){return this.darkmode?"white":"black"},color:{get vel(){return mec.darkmode?"lightsteelblue":"steelblue"},get acc(){return mec.darkmode?"lightsalmon":"firebrick"},get force(){return mec.darkmode?"wheat":"saddlebrown"}},gravity:{x:0,y:-10,active:false},aly:{mass:{get scl(){return 1},type:"num",name:"m",unit:"kg"},vel:{get scl(){return mec.m_u},type:"vec",name:"v",unit:"m/s",get drwscl(){return 40*mec.m_u}},acc:{get scl(){return mec.m_u},type:"vec",name:"a",unit:"m/s^2",get drwscl(){return 10*mec.m_u}},w:{get scl(){return 180/Math.PI},type:"num",name:"φ",unit:"°"},wt:{get scl(){return 1},type:"num",name:"ω",unit:"rad/s"},wtt:{get scl(){return 1},type:"num",name:"α",unit:"rad/s^2"},r:{get scl(){return mec.m_u},type:"num",name:"r",unit:"m"},rt:{get scl(){return mec.m_u},type:"num",name:"rt",unit:"m/s"},rtt:{get scl(){return mec.m_u},type:"num",name:"rtt",unit:"m/s^2"},force:{get scl(){return mec.m_u},type:"vec",name:"F",unit:"N",get drwscl(){return 5*mec.m_u}},velAbs:{get scl(){return mec.m_u},type:"num",name:"v",unit:"m/s"},accAbs:{get scl(){return mec.m_u},type:"num",name:"a",unit:"m/s"},forceAbs:{get scl(){return mec.m_u},type:"num",name:"F",unit:"N"},moment:{get scl(){return mec.m_u**2},type:"num",name:"M",unit:"Nm"}},m_u:.01,to_m(t){return t*mec.m_u},from_m(t){return t/mec.m_u},to_N(t){return t*mec.m_u},from_N(t){return t/mec.m_u},to_Nm(t){return t*mec.m_u*mec.m_u},from_Nm(t){return t/mec.m_u/mec.m_u},to_N_m(t){return t},from_N_m(t){return t},to_J(t){return mec.to_Nm(t)},from_J(t){return mec.from_Nm(t)},to_kgm2(t){return t*mec.m_u*mec.m_u},from_kgm2(t){return t/mec.m_u/mec.m_u},isEps(t,s){return t<(s||mec.EPS)&&t>-(s||mec.EPS)},toZero(t,s){return t<(s||mec.EPS)&&t>-(s||mec.EPS)?0:t},clamp(t,s,i){return Math.min(Math.max(t,s),i)},asympClamp(t,s,i){const e=i-s;return e?s+.5*e+Math.tanh(((Math.min(Math.max(t,s),i)-s)/e-.5)*5)*.5*e:s},toRad(t){return t*Math.PI/180},toDeg(t){return t/Math.PI*180},infAngle(t,s){let i=Math.PI,e=2*i,r=s-t%e;if(r>i)r-=e;else if(r<-i)r+=e;return t+r},mixin(t,...s){s.forEach(s=>{t=Object.defineProperties(t,Object.getOwnPropertyDescriptors(s))});return t},assignGetters(t,s){for(const i in s)Object.defineProperty(t,i,{get:s[i],enumerable:true,configurable:true})}};
/**
 * mec.node (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.node={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){this.x0=this.x;this.y0=this.y;this.xt=this.yt=0;this.xtt=this.ytt=0;this.dxt=this.dyt=0;this.Qx=this.Qy=0},init(t){this.model=t;this.im=typeof this.m==="number"?1/this.m:this.m==="infinite"?0:this.base===true?0:1;Object.defineProperty(this,"m",{get:()=>1/this.im,set:t=>this.im=1/t,enumerable:true,configurable:true});Object.defineProperty(this,"base",{get:()=>this.im===0,set:t=>this.im=t?0:1,enumerable:true,configurable:true})},get xtcur(){return this.xt+this.dxt},get ytcur(){return this.yt+this.dyt},get type(){return"node"},get dof(){return this.m===Number.POSITIVE_INFINITY?0:2},get isSleeping(){return this.base||mec.isEps(this.xt,mec.velTol)&&mec.isEps(this.yt,mec.velTol)},get energy(){var t=0;if(!this.base){if(this.model.hasGravity)t+=this.m*(-this.x*this.model.gravity.x-this.y*this.model.gravity.y);t+=.5*this.m*(this.xt**2+this.yt**2)}return t},reset(){if(!this.base){this.x=this.x0;this.y=this.y0}this.xt=this.yt=0;this.xtt=this.ytt=0;this.dxt=this.dyt=0},pre(t){this.x+=(this.xt+.5*this.dxt)*t;this.y+=(this.yt+.5*this.dyt)*t;if(this.Qx||this.Qy){this.dxt=this.Qx*this.im*t;this.dyt=this.Qy*this.im*t}else this.dxt=this.dyt=0},post(t){this.xt+=this.dxt;this.yt+=this.dyt;this.xtt=this.dxt/t;this.ytt=this.dyt/t},asJSON(){return'{ "id":"'+this.id+'","x":'+this.x0+',"y":'+this.y0+(this.base?',"base":true':"")+(this.idloc?',"idloc":"'+this.idloc+'"':"")+" }"},get force(){return{x:this.Qx,y:this.Qy}},get vel(){return{x:this.xt,y:this.yt}},get acc(){return{x:this.xtt,y:this.ytt}},get forceAbs(){return Math.hypot(this.Qx,this.Qy)},get velAbs(){return Math.hypot(this.xt,this.yt)},get accAbs(){return Math.hypot(this.xtt,this.ytt)},get isSolid(){return true},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,mec.selectedElmColor]:false},_info(){return`x:${this.x}<br>y:${this.y}`},hitInner({x:t,y:s,eps:i}){return g2.isPntInCir({x:t,y:s},this,i)},selectBeg({x:t,y:s,t:i}){},selectEnd({x:t,y:s,t:i}){if(!this.base){this.xt=this.yt=this.xtt=this.ytt=0}},drag({x:t,y:s}){this.x=t;this.y=s},get r(){return mec.node.radius},g2(){let t=g2();if(this.model.graphics.linkage.nodes){const s=mec.node.locdir[this.idloc||"n"],i=this.x+3*this.r*s[0],e=this.y+3*this.r*s[1];t=this.base?g2().beg({x:this.x,y:this.y,sh:this.sh}).cir({x:0,y:0,r:5,ls:"@nodcolor",fs:"@nodfill"}).p().m({x:0,y:5}).a({dw:Math.PI/2,x:-5,y:0}).l({x:5,y:0}).a({dw:-Math.PI/2,x:0,y:-5}).z().fill({fs:"@nodcolor"}).end():g2().cir({x:this.x,y:this.y,r:this.r,ls:"#333",fs:"#eee",sh:()=>this.sh});if(this.model.graphics.labels.nodes)t.txt({str:this.id||"?",x:i,y:e,thal:"center",tval:"middle",ls:mec.txtColor})}return t}},radius:5,locdir:{e:[1,0],ne:[Math.SQRT2/2,Math.SQRT2/2],n:[0,1],nw:[-Math.SQRT2/2,Math.SQRT2/2],w:[-1,0],sw:[-Math.SQRT2/2,-Math.SQRT2/2],s:[0,-1],se:[Math.SQRT2/2,-Math.SQRT2/2]}};
/**
 * mec.constraint (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.drive.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.constraint={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){},init(t){this.model=t;if(typeof this.p1==="string")this.p1=this.model.nodeById(this.p1);if(typeof this.p2==="string")this.p2=this.model.nodeById(this.p2);if(!this.hasOwnProperty("ori"))this.ori={type:"free"};if(!this.hasOwnProperty("len"))this.len={type:"free"};const s=this.ori,i=this.len;this._angle=0;if(s.type==="free")this.init_ori_free(s);else if(s.type==="const")this.init_ori_const(s);else if(s.type==="drive")this.init_ori_drive(s);if(i.type==="free")this.init_len_free(i);else if(i.type==="const")this.init_len_const(i);else if(i.type==="drive")this.init_len_drive(i);this.sw=Math.sin(this.w);this.cw=Math.cos(this.w);this.lambda_r=this.dlambda_r=0;this.lambda_w=this.dlambda_w=0},angle(t){return this._angle=mec.infAngle(this._angle,t)},reset(){this.r0=this.len.hasOwnProperty("r0")?this.len.r0:Math.hypot(this.ay,this.ax);this.w0=this.ori.hasOwnProperty("w0")?this.angle(this.ori.w0):this.angle(Math.atan2(this.ay,this.ax));this._angle=this.w0;this.lambda_r=this.dlambda_r=0;this.lambda_w=this.dlambda_w=0},get type(){const t=this.ori,s=this.len;return t.type==="free"&&s.type==="free"?"free":t.type==="free"&&s.type!=="free"?"rot":t.type!=="free"&&s.type==="free"?"tran":t.type!=="free"&&s.type!=="free"?"ctrl":"invalid"},get initialized(){return typeof this.p1==="object"},get dof(){return(this.ori.type==="free"?1:0)+(this.len.type==="free"?1:0)},get forceAbs(){return-this.lambda_r},get moment(){return-this.lambda_w/this.r},hasActiveDrives(t){let s=this.ori,i=this.len;return s.type==="drive"&&(s.input||t<=s.t0+s.Dt*(s.bounce?2:1)*(s.repeat||1)+.5*this.model.timer.dt)||i.type==="drive"&&(i.input||t<=i.t0+i.Dt*(i.bounce?2:1)*(i.repeat||1)+.5*this.model.timer.dt)},dependsOn(t){return this.p1===t||this.p2===t||this.ori&&this.ori.ref===t||this.len&&this.len.ref===t},get ax(){return this.p2.x-this.p1.x},get ay(){return this.p2.y-this.p1.y},get axt(){return this.p2.xtcur-this.p1.xtcur},get ayt(){return this.p2.ytcur-this.p1.ytcur},get axtt(){return this.p2.xtt-this.p1.xtt},get aytt(){return this.p2.ytt-this.p1.ytt},get ori_C(){return this.ay*this.cw-this.ax*this.sw},get ori_Ct(){return this.ayt*this.cw-this.axt*this.sw-this.wt*this.r},get ori_mc(){const t=mec.toZero(this.p1.im+this.p2.im);return t?1/t:0},get len_C(){return this.ax*this.cw+this.ay*this.sw-this.r},get len_Ct(){return this.axt*this.cw+this.ayt*this.sw-this.rt},get len_mc(){let t=mec.toZero(this.p1.im+this.p2.im);return t?1/t:0},pre(t){let s=this.w;this.cw=Math.cos(s);this.sw=Math.sin(s);this.ori_impulse_vel(this.lambda_w*t);this.len_impulse_vel(this.lambda_r*t);this.dlambda_r=this.dlambda_w=0},post(t){this.lambda_w+=this.dlambda_w;this.ori_apply_Q(this.lambda_w);this.lambda_r+=this.dlambda_r;this.len_apply_Q(this.lambda_r)},posStep(){let t,s=this.w;this.cw=Math.cos(s);this.sw=Math.sin(s);return this.type==="free"?true:this.type==="rot"?this.len_pos():this.type==="tran"?this.ori_pos():this.type==="ctrl"?(t=this.ori_pos(),this.len_pos()&&t):false},velStep(t){let s;return this.type==="free"?true:this.type==="rot"?this.len_vel(t):this.type==="tran"?this.ori_vel(t):this.type==="ctrl"?(s=this.ori_vel(t),this.len_vel(t)&&s):false},ori_pos(){const t=this.ori_C,s=-this.ori_mc*t;this.ori_impulse_pos(s);if(this.ori.ref){const t=this.ori.ref;if(this.ori.reftype==="len")t.len_impulse_pos(-(this.ori.ratio||1)*s);else t.ori_impulse_pos(-(this.ori.ratio||1)*this.r/t.r*s)}return mec.isEps(t,mec.lenTol)},ori_vel(t){const s=this.ori_Ct,i=-this.ori_mc*s;this.ori_impulse_vel(i);this.dlambda_w+=i/t;if(this.ori.ref){const s=this.ori.ref,e=this.ori.ratio||1;if(this.ori.reftype==="len"){s.len_impulse_vel(-e*i);s.dlambda_r-=e*i/t}else{s.ori_impulse_vel(this.r/s.r*e*i);s.dlambda_w-=this.r/s.r*e*i/t}}return mec.isEps(s*t,mec.lenTol)},ori_impulse_pos(t){this.p1.x+=this.p1.im*this.sw*t;this.p1.y+=-this.p1.im*this.cw*t;this.p2.x+=-this.p2.im*this.sw*t;this.p2.y+=this.p2.im*this.cw*t},ori_impulse_vel(t){this.p1.dxt+=this.p1.im*this.sw*t;this.p1.dyt+=-this.p1.im*this.cw*t;this.p2.dxt+=-this.p2.im*this.sw*t;this.p2.dyt+=this.p2.im*this.cw*t},ori_apply_Q(t){this.p1.Qx+=this.sw*t;this.p1.Qy+=-this.cw*t;this.p2.Qx+=-this.sw*t;this.p2.Qy+=this.cw*t},len_pos(){const t=this.len_C,s=-this.len_mc*t;this.len_impulse_pos(s);if(this.len.ref){if(this.len.reftype==="ori")this.len.ref.ori_impulse_pos(-(this.len.ratio||1)*s);else this.len.ref.len_impulse_pos(-(this.len.ratio||1)*s)}return mec.isEps(t,mec.lenTol)},len_vel(t){const s=this.len_Ct,i=-this.len_mc*s;this.len_impulse_vel(i);this.dlambda_r+=i/t;if(this.len.ref){const s=this.len.ref,e=this.ori.ratio||1;if(this.len.reftype==="ori"){s.ori_impulse_vel(-e*i);s.dlambda_w-=e*i/t}else{s.len_impulse_vel(-e*i);s.dlambda_r-=e*i/t}}return mec.isEps(s*t,mec.lenTol)},len_impulse_pos(t){this.p1.x+=-this.p1.im*this.cw*t;this.p1.y+=-this.p1.im*this.sw*t;this.p2.x+=this.p2.im*this.cw*t;this.p2.y+=this.p2.im*this.sw*t},len_impulse_vel(t){this.p1.dxt+=-this.p1.im*this.cw*t;this.p1.dyt+=-this.p1.im*this.sw*t;this.p2.dxt+=this.p2.im*this.cw*t;this.p2.dyt+=this.p2.im*this.sw*t},len_apply_Q(t){this.p1.Qx+=-this.cw*t;this.p1.Qy+=-this.sw*t;this.p2.Qx+=this.cw*t;this.p2.Qy+=this.sw*t},init_ori_free(t){this.w0=this.angle(Math.atan2(this.ay,this.ax));mec.assignGetters(this,{w:()=>this.angle(Math.atan2(this.ay,this.ax)),wt:()=>(this.ayt*this.cw-this.axt*this.sw)/this.r,wtt:()=>(this.aytt*this.cw-this.axtt*this.sw)/this.r})},init_ori_const(t){this.w0=t.hasOwnProperty("w0")?t.w0:this.angle(Math.atan2(this.ay,this.ax));if(!!t.ref){const s=t.ref=this.model.constraintById(t.ref)||t.ref,i=t.reftype||"ori",e=t.ratio||1;if(!s.initialized)s.init(this.model);if(i==="ori")mec.assignGetters(this,{w:()=>this.w0+e*(s.w-s.w0),wt:()=>e*s.wt,wtt:()=>e*s.wtt,ori_C:()=>this.r*(this.angle(Math.atan2(this.ay,this.ax))-this.w0)-e*this.r*(s.angle(Math.atan2(s.ay,s.ax))-s.w0),ori_Ct:()=>this.ayt*this.cw-this.axt*this.sw-e*this.r/s.r*(s.ayt*s.cw-s.axt*s.sw),ori_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+e**2*this.r**2/s.r**2*mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}});else{mec.assignGetters(this,{w:()=>this.w0+e*(s.r-s.r0)/this.r,wt:()=>e*s.rt,wtt:()=>e*s.rtt,ori_C:()=>this.r*(this.angle(Math.atan2(this.ay,this.ax))-this.w0)-e*(s.ax*s.cw+s.ay*s.sw-s.r0),ori_Ct:()=>this.ayt*this.cw-this.axt*this.sw-e*(s.axt*s.cw+s.ayt*s.sw),ori_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+e**2*mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}})}}else{mec.assignGetters(this,{w:()=>this.w0,wt:()=>0,wtt:()=>0})}},init_ori_drive(t){this.w0=t.hasOwnProperty("w0")?t.w0:this.angle(Math.atan2(this.ay,this.ax));t.Dw=t.Dw||2*Math.PI;t.t0=t.t0||0;t.Dt=t.Dt||1;if(t.input){t.local_t=0;t.t=(()=>t.local_t);t.inputCallbk=(s=>{t.local_t=s*Math.PI/180*t.Dt/t.Dw})}else t.t=(()=>this.model.timer.t);t.drive=mec.drive.create({func:t.func||t.input&&"static"||"linear",z0:t.ref?0:this.w0,Dz:t.Dw,t0:t.t0,Dt:t.Dt,t:t.t,bounce:t.bounce,repeat:t.repeat});if(!!t.ref){const s=t.ref=this.model.constraintById(t.ref)||t.ref,i=t.reftype||"ori",e=t.ratio||1;if(!s.initialized)s.init(this.model);if(i==="ori")mec.assignGetters(this,{w:()=>this.w0+(s.w-s.w0)+t.drive.f(),wt:()=>s.wt+t.drive.ft(),wtt:()=>s.wtt+t.drive.ftt(),ori_C:()=>this.r*(this.angle(Math.atan2(this.ay,this.ax))-this.w0)-this.r*(s.angle(Math.atan2(s.ay,s.ax))-s.w0)-this.r*t.drive.f(),ori_Ct:()=>this.ayt*this.cw-this.axt*this.sw-this.r/s.r*(s.ayt*s.cw-s.axt*s.sw)-this.r*t.drive.ft(),ori_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+this.r**2/s.r**2*mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}});else mec.assignGetters(this,{w:()=>this.w0+e*(s.r-s.r0)+t.drive.f(),wt:()=>e*s.rt+t.drive.ft(),wtt:()=>e*s.rtt+t.drive.ftt()})}else{mec.assignGetters(this,{w:t.drive.f,wt:t.drive.ft,wtt:t.drive.ftt})}},init_len_free(t){this.r0=Math.hypot(this.ay,this.ax);mec.assignGetters(this,{r:()=>this.ax*this.cw+this.ay*this.sw,rt:()=>this.axt*this.cw+this.ayt*this.sw,rtt:()=>this.axtt*this.cw+this.aytt*this.sw})},init_len_const(t){this.r0=t.hasOwnProperty("r0")?t.r0:Math.hypot(this.ay,this.ax);if(!!t.ref){const s=t.ref=this.model.constraintById(t.ref)||t.ref,i=t.reftype||"len",e=t.ratio||1;if(!s.initialized)s.init(this.model);if(i==="len")mec.assignGetters(this,{r:()=>this.r0+e*(s.r-s.r0),rt:()=>e*s.rt,rtt:()=>e*s.rtt,len_C:()=>this.ax*this.cw+this.ay*this.sw-this.r0-e*(s.ax*s.cw+s.ay*s.sw-s.r0),len_Ct:()=>this.axt*this.cw+this.ayt*this.sw-e*(s.axt*s.cw+s.ayt*s.sw),len_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+e**2*mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}});else mec.assignGetters(this,{r:()=>this.r0+e*s.r*(s.w-s.w0),rt:()=>e*s.wt,rtt:()=>e*s.wtt,len_C:()=>this.ax*this.cw+this.ay*this.sw-this.r0-e*s.r*(s.angle(Math.atan2(s.ay,s.ax))-s.w0),len_Ct:()=>this.axt*this.cw+this.ayt*this.sw-e*(s.ayt*s.cw-s.axt*s.sw),len_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+e**2*mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}})}else{mec.assignGetters(this,{r:()=>this.r0,rt:()=>0,rtt:()=>0})}},init_len_drive(t){this.r0=t.hasOwnProperty("r0")?t.r0:Math.hypot(this.ay,this.ax);t.Dr=t.Dr||100;t.t0=t.t0||0;t.Dt=t.Dt||1;if(t.input){t.local_t=0;t.t=(()=>t.local_t);t.inputCallbk=(s=>{t.local_t=s*t.Dt/t.Dr})}else t.t=(()=>this.model.timer.t);t.drive=mec.drive.create({func:t.func||t.input&&"static"||"linear",z0:this.r0,Dz:t.Dr,t0:t.t0,Dt:t.Dt,t:t.t,bounce:t.bounce,repeat:t.repeat});if(!!t.ref){const s=t.ref=this.model.constraintById(t.ref)||t.ref,i=t.reftype||"len",e=t.ratio||1;if(!s.initialized)s.init(this.model);if(i==="len")mec.assignGetters(this,{r:()=>this.r0+e*(s.r-s.r0)+t.drive.f(),rt:()=>s.rt+t.drive.ft(),rtt:()=>s.rtt+t.drive.ftt(),len_C:()=>this.ax*this.cw+this.ay*this.sw-this.r0-(s.ax*s.cw+s.ay*s.sw-s.r0)-t.drive.f(),len_Ct:()=>this.axt*this.cw+this.ayt*this.sw-(s.axt*s.cw+s.ayt*s.sw)-t.drive.ft(),len_mc:()=>{let t=mec.toZero(this.p1.im+this.p2.im)+mec.toZero(s.p1.im+s.p2.im);return t?1/t:0}});else mec.assignGetters(this,{r:()=>this.r0+e*(s.w-s.w0)+t.drive.f(),rt:()=>e*s.wt+t.drive.ft(),rtt:()=>e*s.wtt+t.drive.ftt()})}else{mec.assignGetters(this,{r:t.drive.f,rt:t.drive.ft,rtt:t.drive.ftt})}},asJSON(){let t='{ "id":"'+this.id+'","p1":"'+this.p1.id+'","p2":"'+this.p2.id+'"';if(this.len&&!(this.len.type==="free")){t+=(this.len.type==="const"?',"len":{ "type":"const"':"")+(this.len.type==="drive"?',"len":{ "type":"drive"':"")+(this.len.ref?',"ref":"'+this.len.ref.id+'"':"")+(this.len.refval?',"refval":"'+this.len.refval+'"':"")+(this.len.r0&&this.len.r0>1e-4?',"r0":'+this.len.r0:"")+(this.len.ratio&&Math.abs(this.len.ratio-1)>1e-4?',"ratio":'+this.len.ratio:"")+(this.len.func?',"func":"'+this.len.func+'"':"")+(this.len.arg?',"arg":"'+this.len.arg+'"':"")+(this.len.t0&&this.len.t0>1e-4?',"t0":'+this.len.t0:"")+(this.len.Dt?this.len.repeat?',"Dt":'+this.len.Dt/this.len.repeat+',"repeat":'+this.len.repeat:',"Dt":'+this.len.Dt:"")+(this.len.Dr?',"Dr":'+this.len.Dr:"")+(this.len.bounce?',"bounce":true':"")+(this.len.input?',"input":true':"")+" }"}if(this.ori&&!(this.ori.type==="free")){t+=(this.ori.type==="const"?',"ori":{ "type":"const"':"")+(this.ori.type==="drive"?',"ori":{ "type":"drive"':"")+(this.ori.ref?',"ref":"'+this.ori.ref.id+'"':"")+(this.ori.refval?',"refval":"'+this.ori.refval+'"':"")+(this.ori.w0&&this.ori.w0>1e-4?',"r0":'+this.ori.w0:"")+(this.ori.ratio&&Math.abs(this.ori.ratio-1)>1e-4?',"ratio":'+this.ori.ratio:"")+(this.ori.func?',"func":"'+this.ori.func+'"':"")+(this.ori.arg?',"arg":"'+this.ori.arg+'"':"")+(this.ori.t0&&this.ori.t0>1e-4?',"t0":'+this.ori.t0:"")+(this.ori.Dt?this.ori.repeat?',"Dt":'+this.ori.Dt/this.ori.repeat+',"repeat":'+this.ori.repeat:',"Dt":'+this.ori.Dt:"")+(this.ori.Dw?',"Dw":'+this.ori.Dw:"")+(this.ori.bounce?',"bounce":true':"")+(this.ori.input?',"input":true':"")+" }"}t+=" }";return t},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,mec.selectedElmColor]:false},hitContour({x:t,y:s,eps:i}){const e=this.p1,r=this.p2,h=this.p2.x-this.p1.x,n=this.p2.y-this.p1.y,o=2*mec.node.radius/Math.hypot(n,h);return g2.isPntOnLin({x:t,y:s},{x:e.x+o*h,y:e.y+o*n},{x:r.x-o*h,y:r.y-o*n},i)},get color(){return this.model.valid?mec.validConstraintColor:mec.invalidConstraintColor},g2(){let t=g2();if(this.model.graphics.linkage.constraints){const{p1:s,p2:i,w:e,r:r,type:h,ls:n,ls2:o,lw:a,id:l,idloc:p}=this;t.beg({x:s.x,y:s.y,w:e,scl:1,lw:2,ls:mec.constraintVectorColor,fs:"@ls",lc:"round",sh:()=>this.sh}).stroke({d:`M50,0 ${r},0`,ls:()=>this.color,lw:a+1,lsh:true}).drw({d:mec.constraint.arrow[h],lsh:true}).end();if(this.model.graphics.labels.constraints){let i=l||"?",r=Math.cos(e),h=Math.sin(e),n=p==="left"?.5:p==="right"?-.5:p+0===p?p:.5,o=Math.abs(n)*40,a=n>0?10:-15,d=s.x+o*r-a*h,c=s.y+o*h+a*r;if(this.ori.type==="ref"||this.len.type==="ref"){const t=this.ori.type==="ref"&&this.len.type==="ref"?",":"";i+="("+(this.ori.type==="ref"?this.ori.ref.id:"")+t+(this.len.type==="ref"?this.len.ref.id:"")+")";d-=3*h;c+=3*r}t.txt({str:i,x:d,y:c,thal:"center",tval:"middle",ls:mec.txtColor})}}return t}},arrow:{ctrl:"M0,0 35,0M45,0 36,-3 37,0 36,3 Z",rot:"M12,0 8,6 12,0 8,-6Z M0,0 8,0M15,0 35,0M45,0 36,-3 37,0 36,3 Z",tran:"M0,0 12,0M16,0 18,0M22,0 24,0 M28,0 35,0M45,0 36,-3 37,0 36,3 Z",free:"M12,0 8,6 12,0 8,-6ZM0,0 8,0M15,0 18,0M22,0 24,0 M28,0 35,0M45,0 36,-3 37,0 36,3 Z"}};
/**
 * mec.drive (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 */
"use strict";mec.drive={create({func:t,z0:s,Dz:i,t0:e,Dt:r,t:h,bounce:n,repeat:o}){const a=(t,s,i)=>t>s&&t<=i;let l=t&&t in mec.drive?mec.drive[t]:mec.drive.linear;if(n){l=mec.drive.bounce(l);r*=2}if(o){l=mec.drive.bounce(l,o);r*=o}return{f:()=>s+l.f(Math.max(0,Math.min((h()-e)/r,1)))*i,ft:()=>a(h(),e,e+r)?l.fd((h()-e)/r)*i/r:0,ftt:()=>a(h(),e,e+r)?l.fdd((h()-e)/r)*i/r/r:0}},linear:{f:t=>t,fd:t=>1,fdd:t=>0},quadratic:{f:t=>t<=.5?2*t*t:-2*t*t+4*t-1,fd:t=>t<=.5?4*t:-4*t+4,fdd:t=>t<=.5?4:-4},harmonic:{f:t=>(1-Math.cos(Math.PI*t))/2,fd:t=>Math.PI/2*Math.sin(Math.PI*t),fdd:t=>Math.PI*Math.PI/2*Math.cos(Math.PI*t)},sinoid:{f:t=>t-Math.sin(2*Math.PI*t)/2/Math.PI,fd:t=>1-Math.cos(2*Math.PI*t),fdd:t=>Math.sin(2*Math.PI*t)*2*Math.PI},poly5:{f:t=>(10-15*t+6*t*t)*t*t*t,fd:t=>(30-60*t+30*t*t)*t*t,fdd:t=>(60-180*t+120*t*t)*t},static:{f:t=>t,fd:t=>0,fdd:t=>0},ramp(t){t=mec.clamp(t,0,.5);if(t===0)return mec.drive.linear;else if(t===.5)return mec.drive.quadratic;else{const s=1/((1-t)*t);return{f:function(i){return i<t?1/2*s*i*i:i<1-t?s*(i-1/2*t)*t:s*(1-3/2*t)*t+s*(i+t-1)*t-1/2*s*(i+t-1)*(i+t-1)},fd:function(i){return i<t?s*i:i<1-t?s*t:s*t-s*(i+t-1)},fdd:function(i){return i<t?s:i<1-t?0:-s}}}},bounce:function(t){if(typeof t==="string")t=mec.drive[t];return{f:s=>t.f(s<.5?2*s:2-2*s),fd:s=>t.fd(s<.5?2*s:2-2*s)*(s<.5?1:-1),fdd:s=>t.fdd(s<.5?2*s:2-2*s)*(s<.5?1:-1)}},repeat:function(t,s){if(typeof t==="string")t=mec.drive[t];return{f:i=>t.f(i*s%1),fd:i=>t.fd(i*s%1),fdd:i=>t.fdd(i*s%1)}},pot:[{f:t=>1,fd:t=>0,fdd:t=>0},{f:t=>t,fd:t=>1,fdd:t=>0},{f:t=>t*t,fd:t=>2*t,fdd:t=>2},{f:t=>t*t*t,fd:t=>3*t*t,fdd:t=>6*t},{f:t=>t*t*t*t,fd:t=>4*t*t*t,fdd:t=>12*t*t},{f:t=>t*t*t*t*t,fd:t=>5*t*t*t*t,fdd:t=>20*t*t*t}],inPot(t){return this.pot[t]},outPot(t){const s=this.pot[t];return{f:t=>1-s.f(1-t),fd:t=>s.fd(1-t),fdd:t=>-s.fdd(1-t)}},inOutPot(t){const s=this.pot[t],i=Math.pow(2,t-1);return{f:t=>t<.5?i*s.f(t):1-i*s.f(1-t),fd:t=>t<.5?i*s.fd(t):i*s.fd(1-t),fdd:e=>e<.5?i*(t-1)*s.fdd(e):-i*(t-1)*s.fdd(1-e)}},get inQuad(){return this.inPot(2)},get outQuad(){return this.outPot(2)},get inOutQuad(){return this.inOutPot(2)},get inCubic(){return this.inPot(3)},get outCubic(){return this.outPot(3)},get inOutCubic(){return this.inOutPot(3)},get inQuart(){return this.inPot(4)},get outQuart(){return this.outPot(4)},get inOutQuart(){return this.inOutPot(4)},get inQuint(){return this.inPot(5)},get outQuint(){return this.outPot(5)},get inOutQuint(){return this.inOutPot(5)}};
/**
 * mec.load (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.load={extend(t){if(!t.type)t.type="force";if(mec.load[t.type]){Object.setPrototypeOf(t,mec.load[t.type]);t.constructor()}return t}};mec.load.force={constructor(){},init(t){this.model=t;this.init_force(t)},init_force(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref);this.value=mec.from_N(this.value||1);this.w0=typeof this.w0==="number"?this.w0:0},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","id":"'+this.id+'","p":"'+this.p.id+'"'+(!!this.mode&&this.mode==="push"?',"mode":"push"':"")+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+(this.wref?',"wref":'+this.wref.id+'"':"")+(this.value&&Math.abs(mec.to_N(this.value)-1)>1e-4?',"value":'+mec.to_N(this.value):"")+" }"},get w(){return this.wref?this.wref.w+this.w0:this.w0},get Qx(){return this.value*Math.cos(this.w)},get Qy(){return this.value*Math.sin(this.w)},reset(){},apply(){this.p.Qx+=this.Qx;this.p.Qy+=this.Qy},get forceAbs(){return this.value},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,"yellow"]:false},hitContour({x:t,y:s,eps:i}){const e=45,r=this.p,h=Math.cos(this.w),n=Math.sin(this.w),o=2*mec.node.radius,a=this.mode==="push"?r.x-(e+o)*h:r.x+o*h,l=this.mode==="push"?r.y-(e+o)*n:r.y+o*n;return g2.isPntOnLin({x:t,y:s},{x:a+o*h,y:l+o*n},{x:a+(e+o)*h,y:l+(e+o)*n},i)},g2(){const t=this.w,s=Math.cos(t),i=Math.sin(t),e=this.p,r=mec.load.force.arrowLength,h=2*mec.node.radius,n=this.mode==="push"?-1:1,o=e.x+n*25*s-12*i,a=e.y+n*25*i+12*s,l=this.mode==="push"?()=>e.x-(r+h)*s:()=>e.x+h*s,p=this.mode==="push"?()=>e.y-(r+h)*i:()=>e.y+h*i,d=g2().beg({x:l,y:p,w:t,scl:1,lw:2,ls:mec.forceColor,lc:"round",sh:()=>this.sh,fs:"@ls"}).drw({d:mec.load.force.arrow,lsh:true}).end();if(this.model.graphics.labels.loads)d.txt({str:this.id||"?",x:o,y:a,thal:"center",tval:"middle",ls:mec.txtColor});return d},arrowLength:45,arrow:"M0,0 35,0M45,0 36,-3 37,0 36,3 Z"};mec.load.spring={constructor(){},init(t){this.model=t;this.init_spring(t)},init_spring(t){if(typeof this.p1==="string")this.p1=t.nodeById(this.p1);if(typeof this.p2==="string")this.p2=t.nodeById(this.p2);this.k=mec.from_N_m(this.k||.01);this.len0=typeof this.len0==="number"?this.len0:Math.hypot(this.p2.x-this.p1.x,this.p2.y-this.p1.y)},dependsOn(t){return this.p1===t||this.p2===t},asJSON(){return'{ "type":"'+this.type+'","id":"'+this.id+'","p1":"'+this.p1.id+'","p2":"'+this.p2.id+'"'+(this.k&&!(mec.to_N_m(this.k)===.01)?',"k":'+mec.to_N_m(this.k):"")+(this.len0&&Math.abs(this.len0-Math.hypot(this.p2.x0-this.p1.x0,this.p2.y0-this.p1.y0))>1e-4?',"len0":'+this.len0:"")+" }"},get len(){return Math.hypot(this.p2.y-this.p1.y,this.p2.x-this.p1.x)},get w(){return Math.atan2(this.p2.y-this.p1.y,this.p2.x-this.p1.x)},get force(){return this.k*(this.len-this.len0)},get Qx(){return this.force*Math.cos(this.w)},get Qy(){return this.force*Math.sin(this.w)},reset(){},apply(){const t=this.force,s=this.w,i=t*Math.cos(s),e=t*Math.sin(s);this.p1.Qx+=i;this.p1.Qy+=e;this.p2.Qx-=i;this.p2.Qy-=e},get forceAbs(){return this.force},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,"yellow"]:false},hitContour({x:t,y:s,eps:i}){const e=this.p1,r=this.p2,h=Math.cos(this.w),n=Math.sin(this.w),o=2*mec.node.radius;return g2.isPntOnLin({x:t,y:s},{x:e.x+o*h,y:e.y+o*n},{x:r.x-o*h,y:r.y-o*n},i)},g2(){const t=16;const s=this.p1.x,i=this.p1.y;const e=this.p2.x,r=this.p2.y;const h=Math.hypot(e-s,r-i);const n=(s+e)/2;const o=(i+r)/2;const a=(e-s)/h;const l=(r-i)/h;const p=2*mec.node.radius;return g2().p().m({x:s+a*p,y:i+l*p}).l({x:n-a*t/2,y:o-l*t/2}).l({x:n+(-a/6+l/2)*t,y:o+(-l/6-a/2)*t}).l({x:n+(a/6-l/2)*t,y:o+(l/6+a/2)*t}).l({x:n+a*t/2,y:o+l*t/2}).l({x:e-a*p,y:r-l*p}).stroke(Object.assign({},{ls:mec.springColor},this,{fs:"transparent",lc:"round",lw:2,lj:"round",sh:()=>this.sh,lsh:true}))}};
/**
 * mec.shape (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.view={extend(t){if(t.type&&mec.view[t.type]){Object.setPrototypeOf(t,mec.view[t.type]);t.constructor()}return t}};mec.view.vector={constructor(){},init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p)},dependsOn(t){return this.p===t},reset(){},asJSON(){return'{ "type":"'+this.type+'","id":"'+this.id+'","p":"'+this.p.id+'"'+(this.value?',"value":"'+this.value+'"':"")+" }"},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:false},get endPoints(){const t=mec.aly[this.value].drwscl;const s=this.p[this.value];const i=Math.hypot(s.y,s.x);const e=!mec.isEps(i)?mec.asympClamp(t*i,25,100):0;return{p1:this.p,p2:{x:this.p.x+s.x/i*e,y:this.p.y+s.y/i*e}}},hitContour({x:t,y:s,eps:i}){const e=this.endPoints;return g2.isPntOnLin({x:t,y:s},e.p1,e.p2,i)},g2(){const t=this.endPoints;return g2().vec({x1:t.p1.x,y1:t.p1.y,x2:t.p2.x,y2:t.p2.y,ls:mec.color[this.value],lw:1.5,sh:this.sh})}};mec.view.trace={constructor(){},init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);this.pts=[];this.t0=0;this.model=t},dependsOn(t){return this.p===t},reset(){this.pts.length=0;this.t0=0},post(t){this.pts.push({x:this.p.x,y:this.p.y});if(this.model.timer.t-this.t0>this.Dt)this.pts.shift()},asJSON(){return'{ "type":"'+this.type+'","id":"'+this.id+'","p":"'+this.p.id+'"'+(this.Dt?',"Dt":'+this.Dt:"")+(this.stroke&&!(this.stroke==="navy")?',"stroke":"'+this.stroke+'"':"")+(this.fill&&!(this.stroke==="transparent")?',"fill":"'+this.fill+'"':"")+" }"},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:false},hitContour({x:t,y:s,eps:i}){return false},g2(){return g2().ply({pts:this.pts,format:"{x,y}",ls:this.stroke||"navy",lw:1.5,fs:this.fill||"transparent",sh:this.sh})}};mec.view.info={constructor(){},init(t){if(typeof this.elem==="string")this.elem=t.elementById(this.elem)},dependsOn(t){return this.elem===t},reset(){},asJSON(){return'{ "type":"'+this.type+'","id":"'+this.id+'","elem":"'+this.elem.id+'"'+(this.value?',"value":"'+this.value+'"':"")+(this.name?',"name":"'+this.name+'"':"")+" }"},get hasInfo(){return this.elem.state===g2.OVER},infoString(){if(this.value in this.elem){const t=this.elem[this.value];const s=mec.aly[this.value];const i=s.type;const e=t=>(t*s.scl).toPrecision(3);return(this.name||s.name||this.value)+": "+(i==="vec"?"{x:"+e(t.x)+",y:"+e(t.x)+"}":e(t))+" "+s.unit}return"?"}};
/**
 * mec.shape (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.shape={extend(t){if(t.type&&mec.shape[t.type]){Object.setPrototypeOf(t,mec.shape[t.type]);t.constructor()}return t}};mec.shape.fix={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p)},dependsOn(t){return this.p===t},asJSON(){return'{ "type":"'+this.type+'","p":"'+this.p.id+'"'+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+" }"},draw(t){t.use({grp:"nodfix",x:()=>this.p.x,y:()=>this.p.y,w:this.w0||0})}},mec.shape.flt={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p)},dependsOn(t){return this.p===t},asJSON(){return'{ "type":"'+this.type+'","p":"'+this.p.id+'"'+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+" }"},draw(t){t.use({grp:"nodflt",x:()=>this.p.x,y:()=>this.p.y,w:this.w0||0})}};mec.shape.slider={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","p":"'+this.p.id+'"'+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+(this.wref?',"wref":"'+this.wref.id+'"':"")+" }"},draw(t){const s=this.wref?()=>this.wref.w:this.w0||0;t.beg({x:()=>this.p.x,y:()=>this.p.y,w:s}).rec({x:-16,y:-10,b:32,h:20,ls:"@nodcolor",fs:"@linkfill",lw:1,lj:"round"}).end()}};mec.shape.bar={init(t){if(typeof this.p1==="string"&&typeof this.p2==="string"){this.p1=t.nodeById(this.p1);this.p2=t.nodeById(this.p2)}},dependsOn(t){return this.p1===t||this.p2===t},asJSON(){return'{ "type":"'+this.type+'","p1":"'+this.p1.id+'","p2":"'+this.p2.id+'" }'},draw(t){const s=()=>this.p1.x,i=()=>this.p1.y,e=()=>this.p2.x,r=()=>this.p2.y;t.lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodfill",lw:3,lc:"round"})}};mec.shape.beam={init(t){if(typeof this.wref==="string"&&this.len>0){this.p=t.nodeById(this.p);this.wref=t.constraintById(this.wref)}else{console.log("invalid definition of beam shape in model")}},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","p":"'+this.p.id+'","wref":"'+this.wref.id+'","len":"'+this.len+'" }'},draw(t){const s=()=>this.p.x,i=()=>this.p.y,e=()=>this.p.x+this.len*Math.cos(this.wref.w),r=()=>this.p.y+this.len*Math.sin(this.wref.w);t.lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:s,y1:i,x2:e,y2:r,ls:"@nodfill",lw:3,lc:"round"})}};mec.shape.wheel={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","p":"'+this.p.id+'","r":'+this.r+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+(this.wref?',"wref":"'+this.wref.id+'"':"")+" }"},draw(t){const s=this.wref?()=>this.wref.w:this.w0||0,i=this.r,e=Math.sin(2*Math.PI/3),r=Math.cos(2*Math.PI/3);t.beg({x:()=>this.p.x,y:()=>this.p.y,w:s}).lin({x1:0,y1:0,x2:i-4,y2:0,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:i-4,y2:0,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:i-4,y2:0,ls:"@nodfill",lw:3,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:(i-4)*e,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:(i-4)*e,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:(i-4)*e,ls:"@nodfill",lw:3,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:-(i-4)*e,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:-(i-4)*e,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:(i-4)*r,y2:-(i-4)*e,ls:"@nodfill",lw:3,lc:"round"}).cir({x:0,y:0,r:i-2.5,ls:"#e6e6e6",fs:"transparent",lw:5}).cir({x:0,y:0,r:i,ls:"@nodcolor",fs:"transparent",lw:1}).cir({x:0,y:0,r:i-5,ls:"@nodcolor",fs:"transparent",lw:1}).end()}};mec.shape.poly={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref);this.fill=this.fill||"#aaaaaa88";this.stroke=this.stroke||"transparent"},get x0(){return this.p.x0},get y0(){return this.p.y0},get w0(){return this.wref.w0},get w(){return this.wref.w-this.wref.w0},get x(){const t=this.wref.w-this.wref.w0;return this.p.x-Math.cos(t)*this.p.x0+Math.sin(t)*this.p.y0},get y(){const t=this.wref.w-this.wref.w0;return this.p.y-Math.sin(t)*this.p.x0-Math.cos(t)*this.p.y0},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","pts":'+JSON.stringify(this.pts)+',"p":"'+this.p.id+'"'+(this.wref?',"wref":"'+this.wref.id+'"':"")+(this.w0&&this.w0>1e-4&&!(this.wref.w0===this.w0)?',"w0":'+this.w0:"")+(this.stroke&&!(this.stroke==="transparent")?',"stroke":"'+this.stroke+'"':"")+(this.fill&&!(this.fill==="#aaaaaa88")?',"fill":"'+this.fill+'"':"")+" }"},draw(t){t.ply({pts:this.pts,closed:true,x:()=>this.x,y:()=>this.y,w:()=>this.w,fs:this.fill,ls:this.stroke})}};mec.shape.img={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},asJSON(){return'{ "type":"'+this.type+'","uri":"'+this.uri+'","p":"'+this.p.id+'"'+(this.wref?',"wref":"'+this.wref.id+'"':"")+(this.w0&&this.w0>1e-4?',"w0":'+this.w0:"")+(this.xoff&&Math.abs(this.xoff)>1e-4?',"xoff":'+this.xoff:"")+(this.yoff&&Math.abs(this.yoff)>1e-4?',"yoff":'+this.yoff:"")+(this.scl&&Math.abs(this.scl-1)>1e-4?',"scl":'+this.scl:"")+" }"},draw(t){const s=this.w0||0,i=this.wref?()=>this.wref.w+s:s;t.img({uri:this.uri,x:()=>this.p.x,y:()=>this.p.y,w:i,scl:this.scl,xoff:this.xoff,yoff:this.yoff})}};
/**
 * mec.model (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.drive.js
 * @requires mec.load.js
 * @requires mec.view.js
 * @requires mec.shape.js
 */
"use strict";mec.model={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){this.state={valid:true,itrpos:0,itrvel:0};this.timer={t:0,dt:1/60};if(!this.nodes)this.nodes=[];if(!this.constraints)this.constraints=[];if(!this.loads)this.loads=[];if(!this.views)this.views=[];if(!this.shapes)this.shapes=[];for(const t of this.nodes)mec.node.extend(t);for(const t of this.constraints)mec.constraint.extend(t);for(const t of this.loads)mec.load.extend(t);for(const t of this.views)mec.view.extend(t);for(const t of this.shapes)mec.shape.extend(t)},init(){let t=false;if(this.gravity===true)this.gravity=Object.assign({},mec.gravity,{active:true});else if(!this.gravity)this.gravity=Object.assign({},mec.gravity,{active:false});this.graphics={labels:Object.assign({},mec.labels,!!this.graphics?this.graphics.labels:null),linkage:Object.assign({},mec.linkage,!!this.graphics?this.graphics.linkage:null)};for(let s=0;s<this.nodes.length&&!t;s++)t=this.nodes[s].init(this);for(let s=0;s<this.constraints.length&&!t;s++)if(!this.constraints[s].initialized)t=this.constraints[s].init(this);for(let s=0;s<this.loads.length&&!t;s++)t=this.loads[s].init(this);for(let s=0;s<this.views.length&&!t;s++)t=this.views[s].init(this);for(let s=0;s<this.shapes.length&&!t;s++)t=this.shapes[s].init(this);return t},reset(){this.timer.t=0;for(const t of this.nodes)t.reset();for(const t of this.constraints)t.reset();for(const t of this.loads)t.reset();for(const t of this.views)t.reset();Object.assign(this.state,{valid:true,itrpos:0,itrvel:0});return this},asm(){let t=this.asmPos();t=this.asmVel()&&t;return this},pose(){return this.asmPos()},tick(t){if(t){t=1/60;this.timer.t+=this.timer.dt=t}this.pre().itr().post();return this},stop(){for(const t of this.nodes)t.xt=t.yt=t.xtt=t.ytt=0;return this},get dof(){let t=0;for(const s of this.nodes)t+=s.dof;for(const s of this.constraints)t-=2-s.dof;return t},get hasGravity(){return this.gravity.active},get dirty(){return this.state.dirty},set dirty(t){this.state.dirty=t},get valid(){return this.state.valid},set valid(t){this.state.valid=t},get info(){let t="";for(const s of this.views)if(s.hasInfo)t+=s.infoString()+"<br>";return t.length===0?false:t},get itrpos(){return this.state.itrpos},set itrpos(t){this.state.itrpos=t},get itrvel(){return this.state.itrvel},set itrvel(t){this.state.itrvel=t},get isActive(){return this.hasActiveDrives||!this.isSleeping},get isSleeping(){let t=true;for(const s of this.nodes)t=t&&s.isSleeping;return t},get hasActiveDrives(){let t=false;for(const s of this.constraints)t=t||s.hasActiveDrives(this.timer.t);return t},hasDependents(t){let s=false;for(const i of this.constraints)s=i.dependsOn(t)||s;for(const i of this.loads)s=i.dependsOn(t)||s;for(const i of this.views)s=i.dependsOn(t)||s;for(const i of this.shapes)s=i.dependsOn(t)||s;return s},dependentsOf(t,s){s=s||{constraints:[],loads:[],views:[],shapes:[]};for(const i of this.constraints)if(i.dependsOn(t)){this.dependentsOf(i,s);s.constraints.push(i)}for(const i of this.loads)if(i.dependsOn(t))s.loads.push(i);for(const i of this.views)if(i.dependsOn(t))s.views.push(i);for(const i of this.shapes)if(i.dependsOn(t))s.shapes.push(i);return s},purgeElements(t){for(const s of t.constraints)this.constraints.splice(this.constraints.indexOf(s),1);for(const s of t.loads)this.loads.splice(this.loads.indexOf(s),1);for(const s of t.views)this.views.splice(this.views.indexOf(s),1);for(const s of t.shapes)this.shapes.splice(this.shapes.indexOf(s),1)},elementById(t){return this.nodeById(t)||this.constraintById(t)||this.loadById(t)||this.viewById(t)},addNode(t){this.nodes.push(t)},nodeById(t){for(const s of this.nodes)if(s.id===t)return s;return false},removeNode(t){const s=this.hasDependents(t);if(!s)this.nodes.splice(this.nodes.indexOf(t),1);return!s},purgeNode(t){this.purgeElements(this.dependentsOf(t));this.nodes.splice(this.nodes.indexOf(t),1)},addConstraint(t){this.constraints.push(t)},constraintById(t){for(const s of this.constraints)if(s.id===t)return s;return false},removeConstraint(t){const s=this.hasDependents(t);if(!s)this.constraints.splice(this.constraints.indexOf(t),1);return!s},purgeConstraint(t){this.purgeElements(this.dependentsOf(t));this.constraints.splice(this.constraints.indexOf(t),1)},addLoad(t){this.loads.push(t)},loadById(t){for(const s of this.loads)if(s.id===t)return s;return false},removeLoad(t){const s=this.hasDependents(t);if(!s)this.loads.splice(this.loads.indexOf(t),1);return!s},purgeLoad(t){this.purgeElements(this.dependentsOf(t));this.loads.splice(this.loads.indexOf(t),1)},addShape(t){this.shapes.push(t)},removeShape(t){const s=this.shapes.indexOf(t);if(s>=0)this.shapes.splice(s,1)},purgeShape(t){this.purgeElements(this.dependentsOf(t));this.shapes.splice(this.shapes.indexOf(t),1)},addView(t){this.views.push(t)},viewById(t){for(const s of this.views)if(s.id===t)return s;return false},removeView(t){const s=this.views.indexOf(t);if(s>=0)this.views.splice(s,1)},purgeView(t){this.purgeElements(this.dependentsOf(t));this.views.splice(this.views.indexOf(t),1)},asJSON(){const t=this.nodes.length;const s=this.constraints.length;const i=this.loads.length;const e=this.shapes.length;const r=this.views.length;const h=(t,s)=>t<s-1?",":"";const n="{"+'\n  "id":"'+this.id+'"'+(this.gravity.active?',\n  "gravity":true':"")+(t?',\n  "nodes": [\n':"")+(t?this.nodes.map((s,i)=>"    "+s.asJSON()+h(i,t)+"\n").join(""):"")+(t?s||i||e||r?"  ],\n":"  ]\n":"")+(s?'  "constraints": [\n':"")+(s?this.constraints.map((t,i)=>"    "+t.asJSON()+h(i,s)+"\n").join(""):"")+(s?i||e||r?"  ],\n":"  ]\n":"")+(i?'  "loads": [\n':"")+(i?this.loads.map((t,s)=>"    "+t.asJSON()+h(s,i)+"\n").join(""):"")+(i?e||r?"  ],\n":"  ]\n":"")+(e?'  "shapes": [\n':"")+(e?this.shapes.map((t,s)=>"    "+t.asJSON()+h(s,e)+"\n").join(""):"")+(e?r?"  ],\n":"  ]\n":"")+(r?'  "views": [\n':"")+(r?this.views.map((t,s)=>"    "+t.asJSON()+h(s,r)+"\n").join(""):"")+(r?"  ]\n":"")+"}";return n},applyLoads(){for(const t of this.nodes){t.Qx=t.Qy=0;if(!t.base&&this.hasGravity){t.Qx=t.m*mec.from_N(this.gravity.x);t.Qy=t.m*mec.from_N(this.gravity.y)}}for(const t of this.loads)t.apply();return this},asmPos(){let t=false;this.itrpos=0;while(!t&&this.itrpos++<mec.asmItrMax){t=this.posStep()}return this.valid=t},posStep(){let t=true;for(const s of this.constraints)t=s.posStep()&&t;return t},asmVel(){let t=false;this.itrvel=0;while(!t&&this.itrvel++<mec.asmItrMax)t=this.velStep();return t},velStep(){let t=true;for(const s of this.constraints){t=s.velStep(this.timer.dt)&&t}return t},pre(){this.applyLoads();for(const t of this.nodes)t.pre(this.timer.dt);for(const t of this.constraints)t.pre(this.timer.dt);this.asmPos(this.timer.dt);for(const t of this.views)if(t.pre)t.pre(this.timer.dt);return this},itr(){this.asmVel();return this},post(){for(const t of this.nodes)t.post(this.timer.dt);for(const t of this.constraints)t.post(this.timer.dt);for(const t of this.views)if(t.post)t.post(this.timer.dt);return this},draw(t){for(const s of this.shapes)s.draw(t);for(const s of this.views)t.ins(s);for(const s of this.constraints)t.ins(s);for(const s of this.loads)t.ins(s);for(const s of this.nodes)t.ins(s);return this}}};