/**
 * mec (c) 2018 Stefan Goessner
 * @license MIT License
 */
"use strict";const mec={EPS:1.19209e-7,linTol:.001,angTol:2/180*Math.PI,velTol:.01,forceTol:.1,momentTol:.01,maxLinCorrect:20,asmItrMax:512,itrMax:256,corrMax:64,priority:"velocity",showNodeLabels:false,showConstraintLabels:true,showLoadLabels:true,darkmode:false,get validConstraintColor(){return this.darkmode?"#ffffff99":"#777"},invalidConstraintColor:"#b11",get forceColor(){return this.darkmode?"crimson":"orange"},get springColor(){return this.darkmode?"lightslategray":"@linkcolor"},get constraintVectorColor(){return this.darkmode?"orange":"green"},get hoveredElmColor(){return this.darkmode?"white":"gray"},get selectedElmColor(){return this.darkmode?"yellow":"blue"},get txtColor(){return this.darkmode?"white":"black"},gravity:{x:0,y:-10,active:false},m_u:.01,to_m(t){return t*mec.m_u},from_m(t){return t/mec.m_u},to_N(t){return t*mec.m_u},from_N(t){return t/mec.m_u},to_Nm(t){return t*mec.m_u*mec.m_u},from_Nm(t){return t/mec.m_u/mec.m_u},to_N_m(t){return t},from_N_m(t){return t},to_J(t){return mec.to_Nm(t)},from_J(t){return mec.from_Nm(t)},to_kgm2(t){return t*mec.m_u*mec.m_u},from_kgm2(t){return t/mec.m_u/mec.m_u},isEps(t,i){return t<(i||mec.EPS)&&t>-(i||mec.EPS)},toZero(t,i){return t<(i||mec.EPS)&&t>-(i||mec.EPS)?0:t},clamp(t,i,s){return Math.min(Math.max(t,i),s)},toRad(t){return t*Math.PI/180},toDeg(t){return t/Math.PI*180},mixin(t,...i){i.forEach(i=>{t=Object.defineProperties(t,Object.getOwnPropertyDescriptors(i))});return t}};
/**
 * mec.node (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.node={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){this.x0=this.x;this.y0=this.y;this.xt=this.yt=0;this.xtt=this.ytt=0;this.dxt=this.dyt=0;this.Qx=this.Qy=0},init(t){this.model=t;this.im=typeof this.m==="number"?1/this.m:this.m==="infinite"?0:this.base===true?0:1;Object.defineProperty(this,"m",{get:()=>1/this.im,set:t=>this.im=1/t,enumerable:true,configurable:true});Object.defineProperty(this,"base",{get:()=>this.im===0,set:t=>this.im=t?0:1,enumerable:true,configurable:true})},get xtcur(){return this.xt+this.dxt},get ytcur(){return this.yt+this.dyt},get dof(){return this.m===Number.POSITIVE_INFINITY?0:2},get isSleeping(){return this.base||mec.isEps(this.xt,mec.velTol)&&mec.isEps(this.yt,mec.velTol)},get energy(){var t=0;if(!this.base){if(this.model.hasGravity)t+=this.m*(-this.x*this.model.gravity.x-this.y*this.model.gravity.y);t+=.5*this.m*(this.xt**2+this.yt**2)}return t},reset(){this.x=this.x0;this.y=this.y0;this.xt=this.yt=0;this.xtt=this.ytt=0;this.dxt=this.dyt=0},pre(t){this.x+=this.model.direc*this.xt*t;this.y+=this.model.direc*this.yt*t;this.dxt=this.dyt=0;if(this.Qx||this.Qy){this.dxt=this.Qx*this.im*t;this.dyt=this.Qy*this.im*t}},post(t){this.xt+=this.dxt;this.yt+=this.dyt;this.xtt=this.dxt/t;this.ytt=this.dyt/t},toJSON(){const t={id:this.id,x:this.x,y:this.y};if(this.base)t.base=true;if(this.idloc)t.idloc=this.idloc;return t},get isSolid(){return true},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,mec.selectedElmColor]:false},_info(){return`x:${this.x}<br>y:${this.y}`},hitInner({x:t,y:i,eps:s}){return g2.isPntInCir({x:t,y:i},this,s)},selectBeg({x:t,y:i,t:s}){},selectEnd({x:t,y:i,t:s}){if(!this.base){this.xt=this.yt=this.xtt=this.ytt=0}},drag({x:t,y:i}){this.x=t;this.y=i},get r(){return mec.node.radius},g2(){const t=mec.node.locdir[this.idloc||"n"],i=this.x+3*this.r*t[0],s=this.y+3*this.r*t[1],e=this.base?g2().beg({x:()=>this.x,y:()=>this.y,sh:()=>this.sh}).cir({x:0,y:0,r:5,ls:"@nodcolor",fs:"@nodfill"}).p().m({x:0,y:5}).a({dw:Math.PI/2,x:-5,y:0}).l({x:5,y:0}).a({dw:-Math.PI/2,x:0,y:-5}).z().fill({fs:"@nodcolor"}).end():g2().cir({x:()=>this.x,y:()=>this.y,r:this.r,ls:"#333",fs:"#eee",sh:()=>this.sh});if(mec.showNodeLabels)e.txt({str:this.id||"?",x:i,y:s,thal:"center",tval:"middle",ls:mec.txtColor});return e}},radius:5,locdir:{e:[1,0],ne:[Math.SQRT2/2,Math.SQRT2/2],n:[0,1],nw:[-Math.SQRT2/2,Math.SQRT2/2],w:[-1,0],sw:[-Math.SQRT2/2,-Math.SQRT2/2],s:[0,-1],se:[Math.SQRT2/2,-Math.SQRT2/2]}};
/**
 * mec.constraint (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.drive.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.constraint={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){},init(t){this.model=t;if(typeof this.p1==="string")this.p1=this.model.nodeById(this.p1);if(typeof this.p2==="string")this.p2=this.model.nodeById(this.p2);if(!this.hasOwnProperty("ori"))this.ori={type:"free"};if(!this.hasOwnProperty("len"))this.len={type:"free"};const i=this.ori,s=this.len;if(i.type==="free")this.init_ori_free(i);else if(i.type==="const")this.init_ori_const(i);else if(i.type==="ref")this.init_ori_ref(i);else if(i.type==="drive")this.init_ori_drive(i);if(s.type==="free")this.init_len_free(s);else if(s.type==="const")this.init_len_const(s);else if(s.type==="ref")this.init_len_ref(s);else if(s.type==="drive")this.init_len_drive(s);this.lambda_r=this.dlambda_r=0;this.lambda_w=this.dlambda_w=0},reset(){this.lambda_r=this.dlambda_r=0;this.lambda_w=this.dlambda_w=0},get type(){const t=this.ori,i=this.len;return t.type==="free"&&i.type==="free"?"free":t.type==="free"&&i.type!=="free"?"rot":t.type!=="free"&&i.type==="free"?"tran":t.type!=="free"&&i.type!=="free"?"ctrl":"invalid"},get initialized(){return typeof this.p1==="object"},get dof(){return(this.ori.type==="free"?1:0)+(this.len.type==="free"?1:0)},get force(){return mec.to_N(-this.lambda_r)},get moment(){return mec.to_Nm(-this.lambda_w*this.r)},dependsOn(t){return this.p1===t||this.p2===t||this.ori&&this.ori.ref===t||this.len&&this.len.ref===t},get ax(){return this.p2.x-this.p1.x},get ay(){return this.p2.y-this.p1.y},get axt(){return this.p2.xtcur-this.p1.xtcur},get ayt(){return this.p2.ytcur-this.p1.ytcur},get axtt(){return this.p2.xtt-this.p1.xtt},get aytt(){return this.p2.ytt-this.p1.ytt},get mc1(){return this.p1.im/(this.p1.im+this.p2.im)},get mc2(){return this.p2.im/(this.p1.im+this.p2.im)},get color(){return this.model.valid?mec.validConstraintColor:mec.invalidConstraintColor},init_ori_free(t){this.w0=Math.atan2(this.ay,this.ax);this.assignGetters({w:()=>Math.atan2(this.ay,this.ax),wt:()=>(this.ax*this.ayt-this.ay*this.axt)/this.r**2,wtt:()=>(this.ax*this.aytt-this.ay*this.axtt)/this.r**2})},init_ori_const(t){this.w=this.w0=t.hasOwnProperty("w0")?t.w0:Math.atan2(this.ay,this.ax);this.wt=this.wtt=0},init_ori_ref(t){this.w0=Math.atan2(this.ay,this.ax);t.ratio=t.ratio||1;if(typeof t.ref==="string")t.ref=this.model.constraintById(t.ref);if(!t.ref.initialized)t.ref.init(this.model);if(t.refValue==="len")this.assignGetters({w:()=>this.w0+t.ratio*(t.ref.r-t.ref.r0),wt:()=>t.ratio*t.ref.rt,wtt:()=>t.ratio*t.ref.rtt});else this.assignGetters({w:()=>this.w0+t.ratio*(t.ref.w-t.ref.w0),wt:()=>t.ratio*t.ref.wt,wtt:()=>t.ratio*t.ref.wtt})},init_ori_drive(t){this.w0=t.hasOwnProperty("w0")?t.w0:Math.atan2(this.ay,this.ax);t.drive=mec.drive[t.func||"linear"];t.Dw=t.Dw||2*Math.PI;t.t0=t.t0||0;t.Dt=t.Dt||1;if(t.bounce){t.drive=mec.drive.bounce(t.drive);t.Dt*=2}if(t.repeat){t.drive=mec.drive.repeat(t.drive,t.repeat);t.Dt*=t.repeat}if(t.input){t.input_t=0;t.inputCallbk=(i=>{const s=+i.target.value*Math.PI/180*t.Dt/t.Dw;t.prev_t=t.input_t;t.input_t=s;this.model.timer.dt=Math.PI/180*t.Dt/t.Dw;this.model.direc=Math.sign(t.input_t-t.prev_t)||1})}Object.defineProperty(t,"t",{get:()=>t.input?t.input_t:this.model.timer.t,enumerable:true,configurable:true});this.assignGetters({w:()=>this.w0+t.drive.f(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dw,wt:()=>this.model.timer.t<t.t0||this.model.timer.t>t.t0+t.Dt?0:t.drive.fd(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dw/t.Dt,wtt:()=>this.model.timer.t<t.t0||this.model.timer.t>t.t0+t.Dt?0:t.drive.fdd(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dw/t.Dt**2})},init_len_free(t){this.r0=Math.hypot(this.ay,this.ax);this.assignGetters({r:()=>Math.hypot(this.ay,this.ax),rt:()=>(this.ax*this.axt+this.ay*this.ayt)/Math.hypot(this.ay,this.ax),rtt:()=>(this.ax*this.axtt+this.ay*this.aytt+this.axt**2+this.ayt**2-this.rt**2)/Math.hypot(this.ay,this.ax)})},init_len_const(t){this.r=this.r0=t.hasOwnProperty("r0")?t.r0:Math.hypot(this.ay,this.ax);this.rt=this.rtt=0},init_len_ref(t){this.r0=Math.hypot(this.ay,this.ax);t.ratio=t.ratio||1;if(typeof t.ref==="string")t.ref=this.model.constraintById(t.ref);if(!t.ref.initialized)t.ref.init(this.model);if(t.refValue==="ori")this.assignGetters({r:()=>this.r0+t.ratio*(t.ref.w-t.ref.w0),rt:()=>t.ratio*t.ref.wt,rtt:()=>t.ratio*t.ref.wtt});else this.assignGetters({r:()=>this.r0+t.ratio*(t.ref.r-t.ref.r0),rt:()=>t.ratio*t.ref.rt,rtt:()=>t.ratio*t.ref.rtt})},init_len_drive(t){this.r0=t.hasOwnProperty("r0")?t.r0:Math.hypot(this.ay,this.ax);t.drive=mec.drive[t.func||"linear"];t.Dr=t.Dr||100;t.t0=t.t0||0;t.Dt=t.Dt||1;if(t.bounce){t.drive=mec.drive.bounce(t.drive);t.Dt*=2}if(t.repeat){t.drive=mec.drive.repeat(t.drive,t.repeat);t.Dt*=t.repeat}if(t.input){t.input_t=0;t.inputCallbk=(i=>{const s=t.Dt/t.Dr,e=+i.target.value*s;t.prev_t=t.input_t;t.input_t=e;this.model.timer.dt=s;this.model.direc=Math.sign(t.input_t-t.prev_t)||1})}Object.defineProperty(t,"t",{get:()=>t.input?t.input_t:this.model.timer.t,enumerable:true,configurable:true});this.assignGetters({r:()=>this.r0+t.drive.f(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dr,rt:()=>this.model.timer.t<t.t0||this.model.timer.t>t.t0+t.Dt?0:t.drive.fd(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dr/t.Dt,rtt:()=>this.model.timer.t<t.t0||this.model.timer.t>t.t0+t.Dt?0:t.drive.fdd(Math.max(0,Math.min((t.t-t.t0)/t.Dt,1)))*t.Dw/t.Dt**2})},posStep(){let t;return this.type==="free"?true:this.type==="rot"?this.len_pos():this.type==="tran"?this.ori_pos():this.type==="ctrl"?(t=this.ori_pos(),this.len_pos()&&t):false},velStep(t){let i;return this.type==="free"?true:this.type==="rot"?this.len_vel(t):this.type==="tran"?this.ori_vel(t):this.type==="ctrl"?(i=this.ori_vel(t),this.len_vel(t)&&i):false},pre(t){const i=this.lambda_r*t,s=this.lambda_w*t,e=this.w,r=Math.cos(e),h=Math.sin(e);this.p1.dxt+=-r*this.p1.im*i;this.p1.dyt+=-h*this.p1.im*i;this.p2.dxt+=r*this.p2.im*i;this.p2.dyt+=h*this.p2.im*i;this.p1.dxt+=h*this.p1.im*s;this.p1.dyt+=-r*this.p1.im*s;this.p2.dxt+=-h*this.p2.im*s;this.p2.dyt+=r*this.p2.im*s;this.dlambda_r=this.dlambda_w=0;if(this.ori.type==="ref"){this.ori.ref.lambda_w=0}},post(t){this.lambda_r+=this.dlambda_r;this.lambda_w+=this.dlambda_w;if(this.ori.type==="ref"){this.ori.ref.lambda_w+=this.ori.ratio*this.dlambda_w}},get ori_C(){const t=this.w,i=this.r;return{x:this.ax-i*Math.cos(t),y:this.ay-i*Math.sin(t)}},get ori_Ct(){const t=this.w,i=this.wt,s=Math.cos(t),e=Math.sin(t),r=this.r,h=this.rt;return{x:this.axt-h*s+r*i*e,y:this.ayt-h*e-r*i*s}},get ori_mc(){let t=mec.toZero(this.p1.im+this.p2.im);return t?1/t:0},ori_pos(){const t=this.ori_C,i=1,s=this.ori_mc,e={x:-s*(t.x/=i),y:-s*(t.y/=i)};this.p1.x+=-this.p1.im*e.x;this.p1.y+=-this.p1.im*e.y;this.p2.x+=this.p2.im*e.x;this.p2.y+=this.p2.im*e.y;return mec.isEps(t.x,mec.linTol)&&mec.isEps(t.y,mec.linTol)},ori_vel(t){const i=this.ori_Ct,s=this.ori_mc,e={x:-s*i.x,y:-s*i.y};this.p1.dxt+=-this.p1.im*e.x;this.p1.dyt+=-this.p1.im*e.y;this.p2.dxt+=this.p2.im*e.x;this.p2.dyt+=this.p2.im*e.y;this.dlambda_r+=(e.x*this.ax+e.y*this.ay)/this.r/t;this.dlambda_w+=(-e.x*this.ay+e.y*this.ax)/this.r/t;return mec.isEps(i.x*t,mec.linTol)&&mec.isEps(i.y*t,mec.linTol)},get len_C(){return(this.ax**2+this.ay**2-this.r**2)/(2*this.r0)},get len_Ct(){return(this.ax*this.axt+this.ay*this.ayt-this.r*this.rt)/this.r0},get len_mc(){let t=mec.toZero(this.p1.im+this.p2.im);return(t?1/t:0)*this.r0**2/(this.ax**2+this.ay**2)},len_pos(){const t=this.len_C,i=-this.len_mc*t;this.p1.x+=-this.ax/this.r0*this.p1.im*i;this.p1.y+=-this.ay/this.r0*this.p1.im*i;this.p2.x+=this.ax/this.r0*this.p2.im*i;this.p2.y+=this.ay/this.r0*this.p2.im*i;return mec.isEps(t,mec.linTol)},len_vel(t){const i=this.len_Ct,s=-this.len_mc*i;this.p1.dxt+=-this.ax/this.r0*this.p1.im*s;this.p1.dyt+=-this.ay/this.r0*this.p1.im*s;this.p2.dxt+=this.ax/this.r0*this.p2.im*s;this.p2.dyt+=this.ay/this.r0*this.p2.im*s;this.dlambda_r+=s/t;return mec.isEps(i*t,mec.linTol)},assignGetters(t){for(const i in t)Object.defineProperty(this,i,{get:t[i],enumerable:true,configurable:true})},toJSON(){const t={id:this.id,p1:this.p1.id,p2:this.p2.id};if(this.len)t.len={type:this.len.type};if(this.len.type==="ref")t.len.ref=this.len.ref.id;if(this.ori.type==="drive"){t.len.func=this.len.func;t.len.Dt=this.len.Dt;t.len.Dw=this.len.Dw;t.len.input=this.len.input;t.len.output=this.len.output}if(this.ori)t.ori={type:this.ori.type};if(this.ori.type==="ref")t.ori.ref=this.ori.ref.id;if(this.ori.type==="drive"){t.ori.func=this.ori.func;t.ori.Dt=this.ori.Dt;t.ori.Dw=this.ori.Dw;t.ori.input=this.ori.input;t.ori.output=this.ori.output}return t},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,mec.hoveredElmColor]:this.state&g2.EDIT?[0,0,10,mec.selectedElmColor]:false},hitContour({x:t,y:i,eps:s}){const e=this.p1,r=this.p2,h=this.p2.x-this.p1.x,n=this.p2.y-this.p1.y,o=2*mec.node.radius/Math.hypot(n,h);return g2.isPntOnLin({x:t,y:i},{x:e.x+o*h,y:e.y+o*n},{x:r.x-o*h,y:r.y-o*n},s)},g2(){const{p1:t,p2:i,w:s,r:e,type:r,ls:h,ls2:n,lw:o,id:a,idloc:d}=this,p=g2().beg({x:t.x,y:t.y,w:s,scl:1,lw:2,ls:mec.constraintVectorColor,fs:"@ls",lc:"round",sh:()=>this.sh}).stroke({d:`M50,0 ${e},0`,ls:()=>this.color,lw:o+1,lsh:true}).drw({d:mec.constraint.arrow[r],lsh:true}).end();if(mec.showConstraintLabels){let i=a||"?",e=Math.cos(s),r=Math.sin(s),h=t.x+20*e-10*r,n=t.y+20*r+10*e;if(this.ori.type==="ref"){i+="("+this.ori.ref.id+")";h-=3*r;n+=3*e}p.txt({str:i,x:h,y:n,thal:"center",tval:"middle",ls:mec.txtColor})}return p}},arrow:{ctrl:"M0,0 35,0M45,0 36,-3 37,0 36,3 Z",rot:"M12,0 8,6 12,0 8,-6Z M0,0 8,0M15,0 35,0M45,0 36,-3 37,0 36,3 Z",tran:"M0,0 12,0M16,0 18,0M22,0 24,0 M28,0 35,0M45,0 36,-3 37,0 36,3 Z",free:"M12,0 8,6 12,0 8,-6ZM0,0 8,0M15,0 18,0M22,0 24,0 M28,0 35,0M45,0 36,-3 37,0 36,3 Z"}};
/**
 * mec.drive (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 */
"use strict";mec.drive={linear:{f:t=>t,fd:t=>1,fdd:t=>0},quadratic:{f:t=>t<=.5?2*t*t:-2*t*t+4*t-1,fd:t=>t<=.5?4*t:-4*t+4,fdd:t=>t<=.5?4:-4},harmonic:{f:t=>(1-Math.cos(Math.PI*t))/2,fd:t=>Math.PI/2*Math.sin(Math.PI*t),fdd:t=>Math.PI*Math.PI/2*Math.cos(Math.PI*t)},sinoid:{f:t=>t-Math.sin(2*Math.PI*t)/2/Math.PI,fd:t=>1-Math.cos(2*Math.PI*t),fdd:t=>Math.sin(2*Math.PI*t)*2*Math.PI},poly5:{f:t=>(10-15*t+6*t*t)*t*t*t,fd:t=>(30-60*t+30*t*t)*t*t,fdd:t=>(60-180*t+120*t*t)*t},static:{f:t=>t,fd:t=>0,fdd:t=>0},ramp(t){t=mec.clamp(t,0,.5);if(t===0)return mec.drive.linear;else if(t===.5)return mec.drive.quadratic;else{const i=1/((1-t)*t);return{f:function(s){return s<t?1/2*i*s*s:s<1-t?i*(s-1/2*t)*t:i*(1-3/2*t)*t+i*(s+t-1)*t-1/2*i*(s+t-1)*(s+t-1)},fd:function(s){return s<t?i*s:s<1-t?i*t:i*t-i*(s+t-1)},fdd:function(s){return s<t?i:s<1-t?0:-i}}}},bounce:function(t){if(typeof t==="string")t=mec.drive[t];return{f:i=>t.f(i<.5?2*i:2-2*i),fd:i=>t.fd(i<.5?2*i:2-2*i),fdd:i=>t.fdd(i<.5?2*i:2-2*i)}},repeat:function(t,i){if(typeof t==="string")t=mec.drive[t];return{f:s=>t.f(s*i%1),fd:s=>t.fd(s*i%1),fdd:s=>t.fdd(s*i%1)}},pot:[{f:t=>1,fd:t=>0,fdd:t=>0},{f:t=>t,fd:t=>1,fdd:t=>0},{f:t=>t*t,fd:t=>2*t,fdd:t=>2},{f:t=>t*t*t,fd:t=>3*t*t,fdd:t=>6*t},{f:t=>t*t*t*t,fd:t=>4*t*t*t,fdd:t=>12*t*t},{f:t=>t*t*t*t*t,fd:t=>5*t*t*t*t,fdd:t=>20*t*t*t}],inPot(t){return this.pot[t]},outPot(t){const i=this.pot[t];return{f:t=>1-i.f(1-t),fd:t=>i.fd(1-t),fdd:t=>-i.fdd(1-t)}},inOutPot(t){const i=this.pot[t],s=Math.pow(2,t-1);return{f:t=>t<.5?s*i.f(t):1-s*i.f(1-t),fd:t=>t<.5?s*i.fd(t):s*i.fd(1-t),fdd:e=>e<.5?s*(t-1)*i.fdd(e):-s*(t-1)*i.fdd(1-e)}},get inQuad(){return this.inPot(2)},get outQuad(){return this.outPot(2)},get inOutQuad(){return this.inOutPot(2)},get inCubic(){return this.inPot(3)},get outCubic(){return this.outPot(3)},get inOutCubic(){return this.inOutPot(3)},get inQuart(){return this.inPot(4)},get outQuart(){return this.outPot(4)},get inOutQuart(){return this.inOutPot(4)},get inQuint(){return this.inPot(5)},get outQuint(){return this.outPot(5)},get inOutQuint(){return this.inOutPot(5)}};
/**
 * mec.load (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.load={extend(t){if(!t.type)t.type="force";if(mec.load[t.type]){Object.setPrototypeOf(t,mec.load[t.type]);t.constructor()}return t}};mec.load.force={constructor(){},init(t){this.model=t;this.init_force(t)},init_force(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref);this.value=mec.from_N(this.value||1);this.w0=typeof this.w0==="number"?this.w0:0},dependsOn(t){return this.p===t||this.wref===t},toJSON(){const t={type:this.type,id:this.id,p:this.p.id};if(this.w0&&!(this.w0===0))t.w0=this.w0;if(this.wref)t.wref=this.wref;if(this.value&&Math.abs(mec.to_N(this.value)-1)>1e-4)t.value=mec.to_N(this.value);return t},get w(){return this.wref?this.wref.w+this.w0:this.w0},get Qx(){return this.value*Math.cos(this.w)},get Qy(){return this.value*Math.sin(this.w)},reset(){},apply(){this.p.Qx+=mec.from_N(this.Qx);this.p.Qy+=mec.from_N(this.Qy)},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,"white"]:this.state&g2.EDIT?[0,0,10,"yellow"]:false},hitContour({x:t,y:i,eps:s}){const e=45,r=this.p,h=Math.cos(this.w),n=Math.sin(this.w),o=2*mec.node.radius,a=this.mode==="push"?r.x-(e+o)*h:r.x+o*h,d=this.mode==="push"?r.y-(e+o)*n:r.y+o*n;return g2.isPntOnLin({x:t,y:i},{x:a+o*h,y:d+o*n},{x:a+(e+o)*h,y:d+(e+o)*n},s)},g2(){const t=this.w,i=Math.cos(t),s=Math.sin(t),e=this.p,r=mec.load.force.arrowLength,h=2*mec.node.radius,n=this.mode==="push"?-1:1,o=e.x+n*25*i-12*s,a=e.y+n*25*s+12*i,d=this.mode==="push"?()=>e.x-(r+h)*i:()=>e.x+h*i,p=this.mode==="push"?()=>e.y-(r+h)*s:()=>e.y+h*s,f=g2().beg({x:d,y:p,w:t,scl:1,lw:2,ls:mec.forceColor,lc:"round",sh:()=>this.sh,fs:"@ls"}).drw({d:mec.load.force.arrow,lsh:true}).end();if(mec.showLoadLabels)f.txt({str:this.id||"?",x:o,y:a,thal:"center",tval:"middle",ls:mec.txtColor});return f},arrowLength:45,arrow:"M0,0 35,0M45,0 36,-3 37,0 36,3 Z"};mec.load.spring={constructor(){},init(t){this.model=t;this.init_spring(t)},init_spring(t){if(typeof this.p1==="string")this.p1=t.nodeById(this.p1);if(typeof this.p2==="string")this.p2=t.nodeById(this.p2);this.k=mec.from_N_m(this.k||.01);this.len0=typeof this.len0==="number"?this.len0:Math.hypot(this.p2.x-this.p1.x,this.p2.y-this.p1.y)},dependsOn(t){return this.p1===t||this.p2===t},toJSON(){const t={type:this.type,id:this.id,p1:this.p1.id,p2:this.p2.id};console.log(Math.abs(this.len0-Math.hypot(this.p2.x0-this.p1.x0,this.p2.y0-this.p1.y0)));if(this.k&&!(mec.to_N_m(this.k)===.01))t.k=mec.to_N_m(this.k);if(this.len0&&Math.abs(this.len0-Math.hypot(this.p2.x0-this.p1.x0,this.p2.y0-this.p1.y0))>1e-4)t.len0=this.len0;return t},get len(){return Math.hypot(this.p2.y-this.p1.y,this.p2.x-this.p1.x)},get w(){return Math.atan2(this.p2.y-this.p1.y,this.p2.x-this.p1.x)},get force(){return this.k*(this.len-this.len0)},get Qx(){return this.force*Math.cos(this.w)},get Qy(){return this.force*Math.sin(this.w)},reset(){},apply(){const t=this.force,i=this.w,s=t*Math.cos(i),e=t*Math.sin(i);this.p1.Qx+=s;this.p1.Qy+=e;this.p2.Qx-=s;this.p2.Qy-=e},get isSolid(){return false},get sh(){return this.state&g2.OVER?[0,0,10,"white"]:this.state&g2.EDIT?[0,0,10,"yellow"]:false},hitContour({x:t,y:i,eps:s}){const e=this.p1,r=this.p2,h=Math.cos(this.w),n=Math.sin(this.w),o=2*mec.node.radius;return g2.isPntOnLin({x:t,y:i},{x:e.x+o*h,y:e.y+o*n},{x:r.x-o*h,y:r.y-o*n},s)},g2(){const t=16;const i=this.p1.x,s=this.p1.y;const e=this.p2.x,r=this.p2.y;const h=Math.hypot(e-i,r-s);const n=(i+e)/2;const o=(s+r)/2;const a=(e-i)/h;const d=(r-s)/h;const p=2*mec.node.radius;return g2().p().m({x:i+a*p,y:s+d*p}).l({x:n-a*t/2,y:o-d*t/2}).l({x:n+(-a/6+d/2)*t,y:o+(-d/6-a/2)*t}).l({x:n+(a/6-d/2)*t,y:o+(d/6+a/2)*t}).l({x:n+a*t/2,y:o+d*t/2}).l({x:e-a*p,y:r-d*p}).stroke(Object.assign({},{ls:mec.springColor},this,{fs:"transparent",lc:"round",lw:2,lj:"round",sh:()=>this.sh,lsh:true}))}};
/**
 * mec.shape (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.model.js
 * @requires g2.js
 */
"use strict";mec.shape={extend(t){if(t.type&&mec.shape[t.type]){Object.setPrototypeOf(t,Object.assign({},this.prototype,mec.shape[t.type]));t.constructor()}return t},prototype:{constructor(){},dependsOn(t){return false}}};mec.shape.fix={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p)},dependsOn(t){return this.p===t},toJSON(){const t={type:this.type,p:this.p.id};if(this.w0&&!(this.w0===0))t.w0=this.w0;return t},draw(t){t.use({grp:"nodfix",x:()=>this.p.x,y:()=>this.p.y,w:this.w0||0})}};mec.shape.flt={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p)},dependsOn(t){return this.p===t},toJSON(){const t={type:this.type,p:this.p.id};if(this.w0&&!(this.w0===0))t.w0=this.w0;return t},draw(t){t.use({grp:"nodflt",x:()=>this.p.x,y:()=>this.p.y,w:this.w0||0})}};mec.shape.slider={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},toJSON(){const t={type:this.type,p:this.p.id};if(this.w0&&!(this.w0===0))t.w0=this.w0;if(this.wref)t.wref=this.wref.id;return t},draw(t){const i=this.wref?()=>this.wref.w:this.w0||0;t.beg({x:()=>this.p.x,y:()=>this.p.y,w:i}).rec({x:-16,y:-10,b:32,h:20,ls:"@nodcolor",fs:"@linkfill",lw:1,lj:"round"}).end()}};mec.shape.bar={init(t){if(typeof this.p1==="string"&&typeof this.p2==="string"){this.p1=t.nodeById(this.p1);this.p2=t.nodeById(this.p2)}},dependsOn(t){return this.p1===t||this.p2===t},toJSON(){const t={type:this.type,p1:this.p1.id,p2:this.p2.id};return t},draw(t){const i=()=>this.p1.x,s=()=>this.p1.y,e=()=>this.p2.x,r=()=>this.p2.y;t.lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodfill",lw:3,lc:"round"})}};mec.shape.beam={init(t){if(typeof this.wref==="string"&&this.len>0){this.p=t.nodeById(this.p);this.wref=t.constraintById(this.wref)}else{console.log("invalid definition of beam shape in model")}},dependsOn(t){return this.p===t||this.wref===t},toJSON(){const t={type:this.type,p:this.p.id,wref:this.wref.id,len:this.len};return t},draw(t){const i=()=>this.p.x,s=()=>this.p.y,e=()=>this.p.x+this.len*Math.cos(this.wref.w),r=()=>this.p.y+this.len*Math.sin(this.wref.w);t.lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:i,y1:s,x2:e,y2:r,ls:"@nodfill",lw:3,lc:"round"})}};mec.shape.wheel={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},toJSON(){const t={type:this.type,p:this.p.id,w0:this.w0,r:this.r};if(this.wref)t.wref=this.wref.id;return t},draw(t){const i=this.wref?()=>this.wref.w:this.w0||0,s=this.r,e=Math.sin(2*Math.PI/3),r=Math.cos(2*Math.PI/3);t.beg({x:()=>this.p.x,y:()=>this.p.y,w:i}).lin({x1:0,y1:0,x2:s-4,y2:0,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:s-4,y2:0,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:s-4,y2:0,ls:"@nodfill",lw:3,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:(s-4)*e,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:(s-4)*e,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:(s-4)*e,ls:"@nodfill",lw:3,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:-(s-4)*e,ls:"@nodcolor",lw:8,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:-(s-4)*e,ls:"@nodfill2",lw:5.5,lc:"round"}).lin({x1:0,y1:0,x2:(s-4)*r,y2:-(s-4)*e,ls:"@nodfill",lw:3,lc:"round"}).cir({x:0,y:0,r:s-2.5,ls:"#e6e6e6",fs:"transparent",lw:5}).cir({x:0,y:0,r:s,ls:"@nodcolor",fs:"transparent",lw:1}).cir({x:0,y:0,r:s-5,ls:"@nodcolor",fs:"transparent",lw:1}).end()}};mec.shape.img={init(t){if(typeof this.p==="string")this.p=t.nodeById(this.p);if(typeof this.wref==="string")this.wref=t.constraintById(this.wref)},dependsOn(t){return this.p===t||this.wref===t},toJSON(){const t={type:this.type,uri:this.uri,p:this.p.id};if(this.wref)t.wref=this.wref.id;if(this.w0&&!(this.w0===0))t.w0=this.w0;if(this.xoff&&!(this.xoff===0))t.xoff=this.xoff;if(this.yoff&&!(this.yoff===0))t.yoff=this.yoff;if(this.scl&&!(this.scl===1))t.scl=this.scl;return t},draw(t){const i=this.w0||0,s=this.wref?()=>this.wref.w+i:i;t.img({uri:this.uri,x:()=>this.p.x,y:()=>this.p.y,w:s,scl:this.scl,xoff:this.xoff,yoff:this.yoff})}};
/**
 * mec.model (c) 2018 Stefan Goessner
 * @license MIT License
 * @requires mec.core.js
 * @requires mec.node.js
 * @requires mec.constraint.js
 * @requires mec.drive.js
 * @requires mec.load.js
 * @requires mec.shape.js
 */
"use strict";mec.model={extend(t){Object.setPrototypeOf(t,this.prototype);t.constructor();return t},prototype:{constructor(){this.state={dirty:true,valid:true,direc:1,itrpos:0,itrvel:0};this.timer={t:0,dt:1/60}},init(){if(!this.nodes)this.nodes=[];for(const t of this.nodes)mec.node.extend(t).init(this);if(!this.constraints)this.constraints=[];for(const t of this.constraints)if(!t.initialized)mec.constraint.extend(t).init(this);if(!this.loads)this.loads=[];for(const t of this.loads)mec.load.extend(t).init(this);if(!this.shapes)this.shapes=[];for(const t of this.shapes)mec.shape.extend(t).init(this);if(this.gravity===true)this.gravity=Object.assign({},mec.gravity,{active:true});else if(!this.gravity)this.gravity=Object.assign({},mec.gravity,{active:false});return this},reset(){this.timer.t=0;for(const t of this.nodes)t.reset();for(const t of this.constraints)t.reset();for(const t of this.loads)t.reset();Object.assign(this.state,{valid:true,direc:1,itrpos:0,itrvel:0});return this},asm(){let t=this.asmPos();t=this.asmVel()&&t;return this},pose(){return this.asmPos()},tick(t){if(t)this.timer.t+=this.timer.dt=t;this.pre().itr().post();return this},stop(){for(const t of this.nodes)t.xt=t.yt=t.xtt=t.ytt=0;return this},get dof(){let t=0;for(const i of this.nodes)t+=i.dof;for(const i of this.constraints)t-=2-i.dof;return t},get hasGravity(){return this.gravity.active},get dirty(){return this.state.dirty},set dirty(t){this.state.dirty=t},get valid(){return this.state.valid},set valid(t){this.state.valid=t},get itrpos(){return this.state.itrpos},set itrpos(t){this.state.itrpos=t},get itrvel(){return this.state.itrvel},set itrvel(t){this.state.itrvel=t},get direc(){return this.state.direc},set direc(t){this.state.direc=t},get isActive(){return this.hasActiveDrives||!this.isSleeping},get isSleeping(){let t=true;for(const i of this.nodes)if(t&&!i.isSleeping)t=false;return t},get hasActiveDrives(){let t=false;for(const i of this.constraints)t=t||i.ori.type==="drive"&&this.timer.t<i.ori.t0+i.ori.Dt||i.len.type==="drive"&&this.timer.t<i.len.t0+i.len.Dt;return t},hasDependents(t){let i=false;for(const s of this.constraints)i=s.dependsOn(t)||i;for(const s of this.loads)i=s.dependsOn(t)||i;for(const s of this.shapes)i=s.dependsOn(t)||i;return i},dependentsOf(t){const i={constraints:[],loads:[],shapes:[]};for(const s of this.constraints)if(s.dependsOn(t))i.constraints.push(s);for(const s of this.loads)if(s.dependsOn(t))i.loads.push(s);for(const s of this.shapes)if(s.dependsOn(t))i.shapes.push(s);return i},purgeElements(t){for(const i of t.constraints)this.constraints.splice(this.constraints.indexOf(i),1);for(const i of t.loads)this.loads.splice(this.loads.indexOf(i),1);for(const t of this.shapes)this.shapes.splice(this.shapes.indexOf(t),1)},addNode(t){this.nodes.push(t)},nodeById(t){for(const i of this.nodes)if(i.id===t)return i;return false},removeNode(t){const i=this.hasDependents(t);if(!i)this.nodes.splice(this.nodes.indexOf(t),1);return!i},purgeNode(t){this.purgeElements(this.dependentsOf(t));this.nodes.splice(this.nodes.indexOf(t),1)},addConstraint(t){this.constraints.push(t)},constraintById(t){for(const i of this.constraints)if(i.id===t)return i;return false},removeConstraint(t){const i=this.hasDependents(t);if(!i)this.constraints.splice(this.constraints.indexOf(t),1);return!i},purgeConstraint(t){this.purgeElements(this.dependentsOf(t));this.constraints.splice(this.constraints.indexOf(t),1)},addLoad(t){this.loads.push(t)},loadById(t){for(const i of this.loads)if(i.id===t)return i;return false},removeLoad(t){const i=this.hasDependents(t);if(!i)this.loads.splice(this.loads.indexOf(t),1);return!i},purgeLoad(t){this.purgeElements(this.dependentsOf(t));this.loads.splice(this.loads.indexOf(t),1)},addShape(t){this.shapes.push(t)},removeShape(t){const i=this.shapes.indexOf(t);if(i>=0)this.shapes.splice(i,1)},purgeShape(t){this.purgeElements(this.dependentsOf(t));this.shapes.splice(this.shapes.indexOf(t),1)},toJSON(){const t={};if(this.id)t.id=this.id;t.dirty=true;if(this.dt)t.dt=this.dt;t.gravity=this.hasGravity?true:false;if(this.nodes&&this.nodes.length>0){const i=[];for(const t of this.nodes)i.push(t.toJSON());t.nodes=i}if(this.constraints&&this.constraints.length>0){const i=[];for(const t of this.constraints)i.push(t.toJSON());t.constraints=i}if(this.loads&&this.loads.length>0){const i=[];for(const t of this.loads)i.push(t.toJSON());t.loads=i}if(this.shapes&&this.shapes.length>0){const i=[];for(const t of this.shapes)i.push(t.toJSON());t.shapes=i}return t},applyLoads(){for(const t of this.nodes){if(!t.base){t.Qx=t.Qy=0;if(this.hasGravity){t.Qx=t.m*mec.from_N(this.gravity.x);t.Qy=t.m*mec.from_N(this.gravity.y)}}}for(const t of this.loads)t.apply();return this},asmPos(){let t=false;this.itrpos=0;while(!t&&this.itrpos++<mec.asmItrMax){t=this.posStep()}return this.valid=t},posStep(){let t=true;for(const i of this.constraints)t=i.posStep()&&t;return t},asmVel(){let t=false;this.itrvel=0;while(!t&&this.itrvel++<mec.asmItrMax)t=this.velStep();return t},velStep(){let t=true;for(const i of this.constraints){t=i.velStep(this.timer.dt)&&t}return t},pre(){this.applyLoads();for(const t of this.nodes)t.pre(this.timer.dt);for(const t of this.constraints)t.pre(this.timer.dt);this.asmPos(this.timer.dt);return this},itr(){this.asmVel();return this},post(){for(const t of this.nodes)t.post(this.timer.dt);for(const t of this.constraints)t.post(this.timer.dt);return this},draw(t){for(const i of this.shapes)i.draw(t);for(const i of this.loads)t.ins(i);for(const i of this.constraints)t.ins(i);for(const i of this.nodes)t.ins(i);return this}}};